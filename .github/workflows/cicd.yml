name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:

jobs:
  python-service:
    name: Python Service
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ---------- LINT ----------
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Python lint
        working-directory: python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff
          ruff check .

      # ---------- HEALTH CHECK ----------
      - name: Python health check
        run: |
          docker build -t python-app ./python
          docker run -d --name python -p 8000:8000 python-app
          for i in {1..20}; do
            if curl -fsS http://localhost:8000/health; then exit 0; fi
            sleep 1
          done
          docker logs python
          exit 1

      # ---------- PUSH ----------
      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push Python image
        if: github.event_name != 'pull_request'
        run: |
          TAG=${GITHUB_SHA::7}
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG=${GITHUB_REF#refs/tags/v}
          fi
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/junior-python:$TAG ./python
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/junior-python:$TAG \
                     ${{ secrets.DOCKERHUB_USERNAME }}/junior-python:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/junior-python:$TAG
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/junior-python:latest

  node-service:
    name: Node Service
    runs-on: ubuntu-latest
    needs: python-service

    steps:
      - uses: actions/checkout@v4

      # ---------- LINT ----------
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Node lint
        working-directory: node
        run: |
          npm ci
          node -c src/index.js

      # ---------- HEALTH CHECK ----------
      - name: Node health check
        run: |
          docker compose up -d --build
          for i in {1..30}; do
            if curl -fsS "http://localhost:3000/multiply?a=5&b=3"; then exit 0; fi
            sleep 1
          done
          docker compose logs
          exit 1

      # ---------- PUSH ----------
      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push Node image
        if: github.event_name != 'pull_request'
        run: |
          TAG=${GITHUB_SHA::7}
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG=${GITHUB_REF#refs/tags/v}
          fi
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/junior-node:$TAG ./node
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/junior-node:$TAG \
                     ${{ secrets.DOCKERHUB_USERNAME }}/junior-node:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/junior-node:$TAG
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/junior-node:latest
